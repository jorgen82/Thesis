/************************************************************************************************************************************************************/
/* Update country column if imported fixtures. This manual update is done for the ports that the Google API could not identify, and its based on research   */
/************************************************************************************************************************************************************/
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'ABO';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'AGBAMI TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'AKPO TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Qatar' WHERE port_load = 'AL SHAHEEN TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Dutch' WHERE port_load = 'ARA';
UPDATE fixtures.fixtures_data SET country = 'Arabian Gulf' WHERE port_load = 'ARABIAN GULF';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'ARMADA PERKASA';
UPDATE fixtures.fixtures_data SET country = 'Tunisia' WHERE port_load = 'ASHTART';
UPDATE fixtures.fixtures_data SET country = 'Vietnam' WHERE port_load = 'BACH HO';
UPDATE fixtures.fixtures_data SET country = 'Panama' WHERE port_load = 'BALBOA';
UPDATE fixtures.fixtures_data SET country = 'Baltic' WHERE port_load = 'BALT';
UPDATE fixtures.fixtures_data SET country = 'Baltic' WHERE port_load = 'BALTIC';
UPDATE fixtures.fixtures_data SET country = 'Cote d Ivoire' WHERE port_load = 'BAOBAB TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Sudan' WHERE port_load = 'BASHAYER';
UPDATE fixtures.fixtures_data SET country = 'Iraq' WHERE port_load = 'BASRAH OIL TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'East Timor' WHERE port_load = 'BAYU UNDAN';
UPDATE fixtures.fixtures_data SET country = 'Indonesia' WHERE port_load = 'BELANAK TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Black Sea' WHERE port_load = 'BLACK SEA';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'BONGA';
--UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'BONNY';
UPDATE fixtures.fixtures_data SET country = 'United States' WHERE port_load = 'BORCO OIL TERMINAL (PINER POINT) - FREEPORT';
UPDATE fixtures.fixtures_data SET country = 'Lybia' WHERE port_load = 'BOURI';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'BRASS TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Baltic' WHERE port_load = 'BSEA';
UPDATE fixtures.fixtures_data SET country = 'Curacao' WHERE port_load = 'BULLEN BAY';
UPDATE fixtures.fixtures_data SET country = 'Malaysia' WHERE port_load = 'BUNGA ORKID';
UPDATE fixtures.fixtures_data SET country = 'Malaysia' WHERE port_load = 'BUNGA RAYA  TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Thailand' WHERE port_load = 'CAKERAWALA TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Gabon' WHERE port_load = 'CAP LOPEZ';
UPDATE fixtures.fixtures_data SET country = 'Caribbean' WHERE port_load = 'CARIBS';
UPDATE fixtures.fixtures_data SET country = 'Mexico' WHERE port_load = 'CAYO ARCAS';
UPDATE fixtures.fixtures_data SET country = 'Malaysia' WHERE port_load = 'CENDOR FSO';
UPDATE fixtures.fixtures_data SET country = 'Malaysia' WHERE port_load = 'CENDOR TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Mediterranean' WHERE port_load = 'CMED';
UPDATE fixtures.fixtures_data SET country = 'Australia' WHERE port_load = 'COSSACK PIONEER';
UPDATE fixtures.fixtures_data SET country = 'Angola' WHERE port_load = 'DALIA TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Malaysia' WHERE port_load = 'DULANG TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'EA TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Egypt' WHERE port_load = 'EGYPTIAN MED';
UPDATE fixtures.fixtures_data SET country = 'Mediterranean' WHERE port_load = 'EMED';
UPDATE fixtures.fixtures_data SET country = 'Denmark' WHERE port_load = 'ENSTED';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'ERHA FPSO';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'ERHA TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'ESCRAVOS';
UPDATE fixtures.fixtures_data SET country = 'Gabon' WHERE port_load = 'ETAME TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'East Asia' WHERE port_load = 'FAR EAST';
UPDATE fixtures.fixtures_data SET country = 'Libya' WHERE port_load = 'FARWAH TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Scotland' WHERE port_load = 'FLOTTA TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'FORCADOS NO.4';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'FORCADOS TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'France' WHERE port_load = 'FOS';
UPDATE fixtures.fixtures_data SET country = 'Gabon' WHERE port_load = 'GAMBA';
UPDATE fixtures.fixtures_data SET country = 'Angola' WHERE port_load = 'GIRASSOL';
UPDATE fixtures.fixtures_data SET country = 'Angola' WHERE port_load = 'GREATER PLUTONIO TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Hong Kong' WHERE port_load = 'HK';
UPDATE fixtures.fixtures_data SET country = 'Venezuela' WHERE port_load = 'JOSE';
UPDATE fixtures.fixtures_data SET country = 'Russia' WHERE port_load = 'KAVKAZ';
UPDATE fixtures.fixtures_data SET country = 'Japan' WHERE port_load = 'KAWASAKI';
UPDATE fixtures.fixtures_data SET country = 'Japan' WHERE port_load = 'KIIRE';
UPDATE fixtures.fixtures_data SET country = 'Malaysia' WHERE port_load = 'KIKEH TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Angola' WHERE port_load = 'KIZOMBA A FPSO';
UPDATE fixtures.fixtures_data SET country = 'South Korea' WHERE port_load = 'KOJE';
UPDATE fixtures.fixtures_data SET country = 'Cameroon' WHERE port_load = 'KOLE';
UPDATE fixtures.fixtures_data SET country = 'Russia' WHERE port_load = 'KOZMINO';
UPDATE fixtures.fixtures_data SET country = 'Azerbaijan' WHERE port_load = 'KULEVI TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Australia' WHERE port_load = 'KUMUL  TERMINAL';
--UPDATE fixtures.fixtures_data SET country = 'Spain' WHERE port_load = 'LAS PALMAS';
UPDATE fixtures.fixtures_data SET country = 'France' WHERE port_load = 'LAVERA';
UPDATE fixtures.fixtures_data SET country = 'Italy' WHERE port_load = 'LEGHORN';
UPDATE fixtures.fixtures_data SET country = 'United States' WHERE port_load = 'LOOP';
UPDATE fixtures.fixtures_data SET country = 'Gabon' WHERE port_load = 'LUCINA  TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Libya' WHERE port_load = 'M E BREGA';
UPDATE fixtures.fixtures_data SET country = 'United Arab Emirates' WHERE port_load = 'M E HAMRA';
UPDATE fixtures.fixtures_data SET country = 'Oman' WHERE port_load = 'MA FAHAL';
UPDATE fixtures.fixtures_data SET country = 'Malaysia' WHERE port_load = 'MALONG TERMINAL';
--UPDATE fixtures.fixtures_data SET country = 'Philippines' WHERE port_load = 'MALAMPAYA PLATFORM';
UPDATE fixtures.fixtures_data SET country = 'Angola' WHERE port_load = 'MALONGO';
UPDATE fixtures.fixtures_data SET country = 'Sudan' WHERE port_load = 'MARSA BASHAYER';
UPDATE fixtures.fixtures_data SET country = 'Mediterranean' WHERE port_load = 'MED';
UPDATE fixtures.fixtures_data SET country = 'Libya' WHERE port_load = 'MELLITAH TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Romania' WHERE port_load = 'MIDIA';
UPDATE fixtures.fixtures_data SET country = 'Kuwait' WHERE port_load = 'MINA SAUD';
UPDATE fixtures.fixtures_data SET country = 'Thailand' WHERE port_load = 'muda terminal';
UPDATE fixtures.fixtures_data SET country = 'Papua New Guinea' WHERE port_load = 'NAPA NAPA';
UPDATE fixtures.fixtures_data SET country = 'North Pacific' WHERE port_load = 'NOPAC';
UPDATE fixtures.fixtures_data SET country = 'North Sea' WHERE port_load = 'NORTH SEA';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'ODUDU TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'OKONO TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Pacific' WHERE port_load = 'PACIFIC';
UPDATE fixtures.fixtures_data SET country = 'Mexico' WHERE port_load = 'PAJARITOS';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'PENNINGTON';
UPDATE fixtures.fixtures_data SET country = 'Peru' WHERE port_load = 'PISCO';
UPDATE fixtures.fixtures_data SET country = 'Guinea' WHERE port_load = 'PUNTA EUROPA TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Chile' WHERE port_load = 'QUINTERO';
UPDATE fixtures.fixtures_data SET country = 'Panama' WHERE port_load = 'RANG DONG';
UPDATE fixtures.fixtures_data SET country = 'Red Sea' WHERE port_load = 'RED SEA';
UPDATE fixtures.fixtures_data SET country = 'Argentina' WHERE port_load = 'RIO CULLEN';
UPDATE fixtures.fixtures_data SET country = 'Red Sea' WHERE port_load = 'RSEA';
UPDATE fixtures.fixtures_data SET country = 'Yemen' WHERE port_load = 'RUDHAM TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Brasil' WHERE port_load = 'SANTOS';
UPDATE fixtures.fixtures_data SET country = 'Scandinavia' WHERE port_load = 'SCANDINAVIA';
UPDATE fixtures.fixtures_data SET country = 'Turkey' WHERE port_load = 'SEA OF MARMARA';
UPDATE fixtures.fixtures_data SET country = 'Bahamas' WHERE port_load = 'SERPENTINA FPSO';
UPDATE fixtures.fixtures_data SET country = 'India' WHERE port_load = 'SIKKA';
UPDATE fixtures.fixtures_data SET country = 'Norway' WHERE port_load = 'SLAGEN';
UPDATE fixtures.fixtures_data SET country = 'Angola' WHERE port_load = 'SOYO';
UPDATE fixtures.fixtures_data SET country = 'Spain' WHERE port_load = 'SPANISH MED';
UPDATE fixtures.fixtures_data SET country = 'Singapore' WHERE port_load = 'SPOR';
UPDATE fixtures.fixtures_data SET country = 'Thailand' WHERE port_load = 'SRIRACHA';
UPDATE fixtures.fixtures_data SET country = 'Antigua Barbuda' WHERE port_load = 'ST JOHNS - SEASONAL';
UPDATE fixtures.fixtures_data SET country = 'Norway' WHERE port_load = 'STURE';
UPDATE fixtures.fixtures_data SET country = 'Egypt' WHERE port_load = 'SUEZ';
UPDATE fixtures.fixtures_data SET country = 'Sweden' WHERE port_load = 'SUTUDDEN HARBOUR';
UPDATE fixtures.fixtures_data SET country = 'Malaysia' WHERE port_load = 'TANJUNG BRUAS';
UPDATE fixtures.fixtures_data SET country = 'United Kingdom' WHERE port_load = 'TEES';
UPDATE fixtures.fixtures_data SET country = 'United Kingdom' WHERE port_load = 'TEESPORT';
UPDATE fixtures.fixtures_data SET country = 'Turkey' WHERE port_load = 'TUTUNCIFILIK';
UPDATE fixtures.fixtures_data SET country = 'United States' WHERE port_load = 'USAC';
UPDATE fixtures.fixtures_data SET country = 'United States' WHERE port_load = 'USWC';
UPDATE fixtures.fixtures_data SET country = 'France' WHERE port_load = 'VAN GOGH';
UPDATE fixtures.fixtures_data SET country = 'Cyprus' WHERE port_load = 'VASSILIKO BAY';
UPDATE fixtures.fixtures_data SET country = 'Australia' WHERE port_load = 'VINCENT';
UPDATE fixtures.fixtures_data SET country = 'West Africa' WHERE port_load = 'W AFRICA';
UPDATE fixtures.fixtures_data SET country = 'West Africa' WHERE port_load = 'WAF';
UPDATE fixtures.fixtures_data SET country = 'India' WHERE port_load = 'WCI';
UPDATE fixtures.fixtures_data SET country = 'Canada' WHERE port_load = 'WHIFFEN HEAD';
UPDATE fixtures.fixtures_data SET country = 'Mediterranean' WHERE port_load = 'WMED';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'YOHO FSO';
UPDATE fixtures.fixtures_data SET country = 'Nigeria' WHERE port_load = 'YOHO TERMINAL';
UPDATE fixtures.fixtures_data SET country = 'Mexico' WHERE port_load = 'YUMM KAK NAAB FPSO';
UPDATE fixtures.fixtures_data SET country = 'Equatorial Guinea' WHERE port_load = 'ZAFIRO OFFSHORE TERMINAL';

UPDATE fixtures.fixtures_data SET country = 'Unknown' WHERE country is null;


/******************************************************************************************/
/* Remove fixtures not in the North US Regon                                              */
/******************************************************************************************/
DELETE FROM fixtures.fixtures_data
WHERE country NOT IN ('Antigua and Barbuda', 'Antigua Barbuda', 'Aruba', 'Bahamas', 'Canada', 'Caribbean', 'Caribbean Netherlands', 'Cayman Islands', 'Curacao', 'Guyana', 'Mexico', 'Saint Lucia', 'The Bahamas', 'Trinidad and Tobago', 'U.S. Virgin Islands', 'United States', 'Unknown', 'Venezuela')


/******************************************************************************************/
/* Overlapping laycan period  - Keep the latest record based on the fixture_date          */
/******************************************************************************************/
DELETE FROM fixtures.fixtures_data
WHERE ID IN (
	SELECT id1
	FROM (
		SELECT 
			ROW_NUMBER() OVER (PARTITION BY a.vessel_name ORDER BY a.fixture_date DESC) AS row_num,
			a.id AS id1,
			b.id AS id2,
			a.vessel_id, 
			a.vessel_name,
			a.fixture_date AS fixture_date1,
			b.fixture_date AS fixture_date2,
			a.laycan_from AS period1_from, 
			a.laycan_to AS period1_to, 
			b.laycan_from AS period2_from, 
			b.laycan_to AS period2_to,
			a.port_load AS port_load1, a.port_discharge AS port_discharge1,
			b.port_load AS port_load2, b.port_discharge AS port_discharge2
		FROM fixtures.fixtures_data a
		JOIN fixtures.fixtures_data b 
			ON a.vessel_name = b.vessel_name 
			AND a.laycan_from < b.laycan_to 
			AND a.laycan_to > b.laycan_from
			AND a.laycan_from != b.laycan_from
		)
	WHERE row_num > 1
	);


/************************************************************************************************************************************/
/* Cleanup od Duplicate Fixtures (ones having different fixture date), by keeping only the ones with the most recent fixture date   */
/************************************************************************************************************************************/
DELETE FROM fixtures.fixtures_data
WHERE ID IN (
	SELECT ID
	FROM (
		SELECT 
			ROW_NUMBER() OVER (PARTITION BY f.vessel_name, f.laycan_from, f.laycan_to ORDER BY fixture_date DESC) AS row_num,
			f.*
		FROM fixtures.fixtures_data f
		INNER JOIN (
			SELECT vessel_name, laycan_from, laycan_to
			FROM fixtures.fixtures_data
			GROUP BY vessel_name, laycan_from, laycan_to
			HAVING COUNT(*)> 1) dup on dup.vessel_name = f.vessel_name AND dup.laycan_from = f.laycan_from AND dup.laycan_to = f.laycan_to
		)
	WHERE row_num > 1
);


/**************************************************************************************************************************************************/
/* Delete the fixtures for the vessels that have not unique vessel name (since we will not be able to correctly match the fixture to the vessel   */
/**************************************************************************************************************************************************/
DELETE FROM fixtures.fixtures_data
WHERE vessel_name IN (
	SELECT vessel_name
	FROM ais.vw_non_unique_vessel_names
)


/********************************************************************/
/* After the cleanup, we will update vessel_id of the fixture table */
/********************************************************************/
UPDATE fixtures.fixtures_data f
SET vessel_id = v.id
FROM ais.vessel v
WHERE v.vessel_name = f.vessel_name
